"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8838],{4217:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"features/hooks","title":"Hooks","description":"Collections Hooks","source":"@site/docs/features/hooks.md","sourceDirName":"features","slug":"/features/hooks","permalink":"/directus-sync/docs/features/hooks","draft":false,"unlisted":false,"editUrl":"https://github.com/directus-sync/directus-sync/tree/main/website/docs/features/hooks.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docs","previous":{"title":"Configuration","permalink":"/directus-sync/docs/features/configuration"},"next":{"title":"Helpers","permalink":"/directus-sync/docs/features/helpers"}}');var o=s(4848),i=s(3023);const r={sidebar_position:4},c="Hooks",a={},l=[{value:"Collections Hooks",id:"collections-hooks",level:2},{value:"Simple Example",id:"simple-example",level:3},{value:"Filtering Out Elements",id:"filtering-out-elements",level:3},{value:"Using the Directus Client",id:"using-the-directus-client",level:3},{value:"Snapshot Hooks",id:"snapshot-hooks",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"hooks",children:"Hooks"})}),"\n",(0,o.jsx)(n.h2,{id:"collections-hooks",children:"Collections Hooks"}),"\n",(0,o.jsxs)(n.p,{children:["In addition to the CLI commands, ",(0,o.jsx)(n.code,{children:"directus-sync"})," also supports hooks. Hooks are JavaScript functions that are executed at specific points during the synchronization process. They can be used to transform the data coming from Directus or going to Directus."]}),"\n",(0,o.jsxs)(n.p,{children:["Hooks are defined in the configuration file using the ",(0,o.jsx)(n.code,{children:"hooks"})," property. Under this property, you can define the collection name and the hook function to be executed. Available collection names are: ",(0,o.jsx)(n.code,{children:"dashboards"}),", ",(0,o.jsx)(n.code,{children:"flows"}),", ",(0,o.jsx)(n.code,{children:"folders"}),", ",(0,o.jsx)(n.code,{children:"operations"}),", ",(0,o.jsx)(n.code,{children:"panels"}),", ",(0,o.jsx)(n.code,{children:"permissions"}),", ",(0,o.jsx)(n.code,{children:"policies"}),", ",(0,o.jsx)(n.code,{children:"presets"}),", ",(0,o.jsx)(n.code,{children:"roles"}),", ",(0,o.jsx)(n.code,{children:"settings"})," and ",(0,o.jsx)(n.code,{children:"translations"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["For each collection, available hook functions are: ",(0,o.jsx)(n.code,{children:"onQuery"}),", ",(0,o.jsx)(n.code,{children:"onLoad"}),", ",(0,o.jsx)(n.code,{children:"onSave"}),", and ",(0,o.jsx)(n.code,{children:"onDump"}),". These can be asynchronous functions."]}),"\n",(0,o.jsxs)(n.p,{children:["During the ",(0,o.jsx)(n.code,{children:"pull"})," command:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"onQuery"})," is executed just before the query is sent to Directus for get elements. It receives the query object as parameter and must return the query object. The second parameter is the Directus client."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"onDump"})," is executed just after the data is retrieved from Directus and before it is saved to the dump files. The data is the raw data received from Directus. The second parameter is the Directus client. It must return the data to be saved to the dump files."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"onSave"}),' is executed just before the cleaned data is saved to the dump files. The "cleaned" data is the data without the columns that are ignored by ',(0,o.jsx)(n.code,{children:"directus-sync"})," (such as ",(0,o.jsx)(n.code,{children:"user_updated"}),") and with the relations replaced by the SyncIDs. The first parameter is the cleaned data and the second parameter is the Directus client. It must return the data to be saved to the dump files."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["During the ",(0,o.jsx)(n.code,{children:"push"})," command:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"onLoad"})," is executed just after the data is loaded from the dump files. The data is the cleaned data, as described above. The first parameter is the data coming from the JSON file and the second parameter is the Directus client. It must return the data."]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"simple-example",children:"Simple Example"}),"\n",(0,o.jsxs)(n.p,{children:["Here is an example of a ",(0,o.jsx)(n.a,{href:"./configuration",children:"configuration file"})," with hooks:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// ./directus-sync.config.js\nmodule.exports = {\n  hooks: {\n    flows: {\n      onDump: (flows) => {\n        return flows.map((flow) => {\n          flow.name = `\ud83e\uddca ${flow.name}`;\n          return flow;\n        });\n      },\n      onSave: (flows) => {\n        return flows.map((flow) => {\n          flow.name = `\ud83d\udd25 ${flow.name}`;\n          return flow;\n        });\n      },\n      onLoad: (flows) => {\n        return flows.map((flow) => {\n          flow.name = flow.name.replace('\ud83d\udd25 ', '');\n          return flow;\n        });\n      },\n    },\n  },\n};\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"warning",children:(0,o.jsxs)(n.p,{children:["The dump hook is called after the mapping of the SyncIDs. This means that the data received by the hook is already tracked. If you filter out some elements, they will be deleted during the ",(0,o.jsx)(n.code,{children:"push"})," command."]})}),"\n",(0,o.jsx)(n.h3,{id:"filtering-out-elements",children:"Filtering Out Elements"}),"\n",(0,o.jsxs)(n.p,{children:["You can use ",(0,o.jsx)(n.code,{children:"onQuery"})," hook to filter out elements. This hook is executed just before the query is sent to Directus, during the ",(0,o.jsx)(n.code,{children:"pull"})," command."]}),"\n",(0,o.jsxs)(n.p,{children:["In the example below, the flows and operations whose name starts with ",(0,o.jsx)(n.code,{children:"Test:"})," are filtered out and will not be tracked."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// ./directus-sync.config.js\nconst testPrefix = 'Test:';\n\nmodule.exports = {\n  hooks: {\n    flows: {\n      onQuery: (query, client) => {\n        query.filter = {\n          ...query.filter,\n          name: { _nstarts_with: testPrefix },\n        };\n        return query;\n      },\n    },\n    operations: {\n      onQuery: (query, client) => {\n        query.filter = {\n          ...query.filter,\n          flow: { name: { _nstarts_with: testPrefix } },\n        };\n        return query;\n      },\n    },\n  },\n};\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsx)(n.p,{children:"Directus-Sync may alter the query after this hook."})}),"\n",(0,o.jsx)(n.h3,{id:"using-the-directus-client",children:"Using the Directus Client"}),"\n",(0,o.jsxs)(n.p,{children:["The example below shows how to disable the flows whose name starts with ",(0,o.jsx)(n.code,{children:"Test:"})," and add the flow name to the operation."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"const { readFlow } = require('@directus/sdk');\n\nconst testPrefix = 'Test:';\n\nmodule.exports = {\n  hooks: {\n    flows: {\n      onDump: (flows) => {\n        return flows.map((flow) => {\n          flow.status = flow.name.startsWith(testPrefix)\n            ? 'inactive'\n            : 'active';\n        });\n      },\n    },\n    operations: {\n      onDump: async (operations, client) => {\n        for (const operation of operations) {\n          const flow = await client.request(readFlow(operation.flow));\n          if (flow) {\n            operation.name = `${flow.name}: ${operation.name}`;\n          }\n        }\n        return operations;\n      },\n    },\n  },\n};\n"})}),"\n",(0,o.jsx)(n.h2,{id:"snapshot-hooks",children:"Snapshot Hooks"}),"\n",(0,o.jsxs)(n.p,{children:["Like the collections hooks, the snapshot hooks are defined in the configuration file using the ",(0,o.jsx)(n.code,{children:"hooks.snapshot"})," property. Under this property, you can define the hook functions to be executed."]}),"\n",(0,o.jsxs)(n.p,{children:["Available hook functions are: ",(0,o.jsx)(n.code,{children:"onLoad"}),", ",(0,o.jsx)(n.code,{children:"onSave"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"onLoad"})," is executed during the ",(0,o.jsx)(n.code,{children:"push"})," and ",(0,o.jsx)(n.code,{children:"diff"})," processes, just after the data is loaded from the files, and before it is sent to Directus."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"onSave"})," is executed during the ",(0,o.jsx)(n.code,{children:"pull"})," process, just before the data is saved to the files."]}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsxs)(n.p,{children:["This function can be ",(0,o.jsx)(n.strong,{children:"asynchronous"}),". It receives the snapshot object and the Directus client as parameters and must return the snapshot object."]})}),"\n",(0,o.jsxs)(n.p,{children:["Here is an example of a configuration file that exclude some fields when loading the snapshot. This will be similar for the ",(0,o.jsx)(n.code,{children:"onSave"})," hook."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-javascript",children:"// ./directus-sync.config.js\nmodule.exports = {\n  hooks: {\n    snapshot: {\n      /**\n       * @param {Snapshot} snapshot\n       * @param {DirectusClient} client\n       */\n      onLoad: async (snapshot, client) => {\n        // Remove some fields from the snapshot\n        const fieldsToExclude = {\n          my_model: ['date_created', 'user_created'],\n        };\n        const collections = Object.keys(fieldsToExclude);\n        const nodeFilter = (node) => {\n          const { collection } = node;\n          return !(collections.includes(collection) && fieldsToExclude[collection].includes(node.field));\n        }\n        snapshot.fields = snapshot.fields.filter(nodeFilter);\n        snapshot.relations = snapshot.relations.filter(nodeFilter);\n\n        return snapshot;\n      },\n    },\n  },\n};\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsxs)(n.p,{children:["For more information about the snapshot object, see the ",(0,o.jsx)(n.a,{href:"https://github.com/tractr/directus-sync/blob/main/packages/cli/src/lib/services/snapshot/interfaces.ts",children:"Snapshot"})," interface."]})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},3023:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>c});var t=s(6540);const o={},i=t.createContext(o);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);